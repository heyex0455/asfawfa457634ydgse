-- ==============================
-- KEY SYSTEM
-- ==============================
local LIFETIME_KEY = "hey"
local TEMP_KEY = "TEMP123456789"
local tempKeyValidUntil = os.time() + 2 * 24 * 60 * 60 -- 2 days

-- ==============================
-- GUI FOR KEY ENTRY
-- ==============================
local Players = game:GetService("Players")
local LocalPlayer = Players.LocalPlayer
local UserInputService = game:GetService("UserInputService")
local RunService = game:GetService("RunService")
local Workspace = game:GetService("Workspace")
local TeleportService = game:GetService("TeleportService")

local ScreenGui = Instance.new("ScreenGui")
ScreenGui.Parent = LocalPlayer:WaitForChild("PlayerGui")

local Frame = Instance.new("Frame")
Frame.Size = UDim2.new(0, 400, 0, 200)
Frame.Position = UDim2.new(0.5, -200, 0.5, -100)
Frame.BackgroundColor3 = Color3.fromRGB(50, 50, 50)
Frame.BorderSizePixel = 0
Frame.Parent = ScreenGui

local TextLabel = Instance.new("TextLabel")
TextLabel.Size = UDim2.new(1, 0, 0, 50)
TextLabel.Position = UDim2.new(0, 0, 0, 0)
TextLabel.Text = "Enter Key to activate script:"
TextLabel.TextColor3 = Color3.fromRGB(255, 255, 255)
TextLabel.BackgroundTransparency = 1
TextLabel.TextScaled = true
TextLabel.Parent = Frame

local TextBox = Instance.new("TextBox")
TextBox.Size = UDim2.new(0.8, 0, 0, 50)
TextBox.Position = UDim2.new(0.1, 0, 0, 70)
TextBox.PlaceholderText = "Enter your key here"
TextBox.TextColor3 = Color3.fromRGB(0,0,0)
TextBox.Text = ""
TextBox.ClearTextOnFocus = false
TextBox.Parent = Frame

local SubmitButton = Instance.new("TextButton")
SubmitButton.Size = UDim2.new(0.4, 0, 0, 40)
SubmitButton.Position = UDim2.new(0.3, 0, 0, 140)
SubmitButton.Text = "Submit"
SubmitButton.BackgroundColor3 = Color3.fromRGB(100, 100, 100)
SubmitButton.TextColor3 = Color3.fromRGB(255,255,255)
SubmitButton.Parent = Frame

-- ==============================
-- FUNCTION TO VALIDATE KEY
-- ==============================
local function isKeyValid(key)
    if key == LIFETIME_KEY then
        return true
    elseif key == TEMP_KEY and os.time() <= tempKeyValidUntil then
        return true
    else
        return false
    end
end

-- ==============================
-- RUN FULL HITBOX + ESP SCRIPT
-- ==============================
local function runScript()
    -- Hide key GUI
    ScreenGui:Destroy()

    -- ==============================
    -- FULL HITBOX + ESP SCRIPT
    -- ==============================
    -- Hitbox Settings
    getgenv().HitboxSize = 15
    getgenv().HitboxTransparency = 0.7
    getgenv().HitboxStatus = false
    getgenv().TeamCheck = false
    getgenv().FriendCheck = false
    getgenv().Walkspeed = 16
    getgenv().Jumppower = 50

    -- Load UI library
    local Library = loadstring(game:HttpGet("https://raw.githubusercontent.com/Vcsk/UI-Library/main/Source/MyUILib(Unamed).lua"))();
    local Window = Library:Create("Hitbox Expander")

    local HomeTab = Window:Tab("Home","rbxassetid://10888331510")
    local PlayerTab = Window:Tab("Players","rbxassetid://12296135476")
    local VisualTab = Window:Tab("Visuals","rbxassetid://12308581351")

    -- Home Tab
    HomeTab:Section("Settings")
    HomeTab:TextBox("Body Hitbox Size (TextBox)", function(value)
        getgenv().HitboxSize = value
    end)
    HomeTab:TextBox("Body Hitbox Transparency", function(number)
        getgenv().HitboxTransparency = number
    end)

    HomeTab:Section("Main")
    HomeTab:Toggle("Status: ", function(state)
        getgenv().HitboxStatus = state
    end)
    HomeTab:Toggle("Team Check", function(state)
        getgenv().TeamCheck = state
    end)
    HomeTab:Keybind("Toggle UI", Enum.KeyCode.F, function()
        Library:ToggleUI()
    end)

    HomeTab:Button("Rejoin", function()
        TeleportService:Teleport(game.PlaceId, Players.LocalPlayer)
    end)

    -- ==============================
    -- NEAREST-TO-CURSOR HOVER HITBOX
    -- ==============================
    local currentHighlighted = nil
    local maxCursorDistance = 200 -- pixels for hover detection
    local hoverDistance = 1000 -- max long-range detection

    local function resetPlayer(char)
        if char then
            local hrp = char:FindFirstChild("HumanoidRootPart")
            if hrp then
                hrp.Size = Vector3.new(2,2,1)
                hrp.Transparency = 1
                hrp.Material = Enum.Material.Plastic
                hrp.CanCollide = true
                hrp.CanTouch = false
            end
        end
    end

    RunService.RenderStepped:Connect(function()
        if getgenv().HitboxStatus then
            local mousePos = UserInputService:GetMouseLocation()
            local camera = Workspace.CurrentCamera
            local closestPlayer = nil
            local closestDistance = maxCursorDistance

            for i, player in pairs(Players:GetPlayers()) do
                if player ~= LocalPlayer and player.Character and player.Character:FindFirstChild("HumanoidRootPart") then
                    local hrp = player.Character.HumanoidRootPart
                    local screenPos, onScreen = camera:WorldToViewportPoint(hrp.Position)
                    if onScreen then
                        local dist = (Vector2.new(screenPos.X, screenPos.Y) - Vector2.new(mousePos.X, mousePos.Y)).Magnitude
                        if dist < closestDistance then
                            closestDistance = dist
                            closestPlayer = player
                        end
                    end
                end
            end

            if currentHighlighted and currentHighlighted.Character then
                resetPlayer(currentHighlighted.Character)
            end

            if closestPlayer and closestPlayer.Character then
                local hrp = closestPlayer.Character:FindFirstChild("HumanoidRootPart")
                if hrp then
                    hrp.Size = Vector3.new(getgenv().HitboxSize, getgenv().HitboxSize, getgenv().HitboxSize)
                    hrp.Transparency = getgenv().HitboxTransparency
                    hrp.Material = Enum.Material.Neon
                    hrp.CanCollide = false
                    hrp.CanTouch = true
                end
                currentHighlighted = closestPlayer
            else
                currentHighlighted = nil
            end
        else
            if currentHighlighted and currentHighlighted.Character then
                resetPlayer(currentHighlighted.Character)
                currentHighlighted = nil
            end
        end
    end)

    -- Player Tab
    PlayerTab:Slider("WalkSpeed", 16,500, function(value)
        getgenv().Walkspeed = value
        pcall(function()
            Players.LocalPlayer.Character.Humanoid.WalkSpeed = value
        end)
    end)
    PlayerTab:Slider("JumpPower", 50,1000, function(value)
        getgenv().Jumppower = value
        pcall(function()
            Players.LocalPlayer.Character.Humanoid.JumpPower = value
        end)
    end)
    PlayerTab:Slider("Fov", 70,120, function(v)
         Workspace.CurrentCamera.FieldOfView = v
    end)

    RunService.Heartbeat:Connect(function()
        if getgenv().loopWJ then
            pcall(function()
                Players.LocalPlayer.Character.Humanoid.WalkSpeed = getgenv().Walkspeed
                Players.LocalPlayer.Character.Humanoid.JumpPower = getgenv().Jumppower
            end)
        end
        if getgenv().loopW then
            pcall(function()
                Players.LocalPlayer.Character.Humanoid.WalkSpeed = getgenv().Walkspeed
            end)
        end
        if getgenv().loopJ then
            pcall(function()
                Players.LocalPlayer.Character.Humanoid.JumpPower = getgenv().Jumppower
            end)
        end
        if getgenv().Noclip then
            local char = Players.LocalPlayer.Character
            if char then
                if char:FindFirstChild("Head") then char.Head.CanCollide = false end
                if char:FindFirstChild("Torso") then char.Torso.CanCollide = false end
            end
        end
    end)

    PlayerTab:Toggle("Loop WalkSpeed/JumpPower", function(state)
        getgenv().loopWJ = state
    end)
    PlayerTab:Toggle("Loop WalkSpeed", function(state)
        getgenv().loopW = state
    end)
    PlayerTab:Toggle("Loop JumpPower", function(state)
        getgenv().loopJ = state
    end)
    PlayerTab:Toggle("Noclip", function(s)
        getgenv().Noclip = s
    end)
    PlayerTab:Toggle("Infinite Jump", function(s)
        getgenv().InfJ = s
    end)

    UserInputService.JumpRequest:Connect(function()
        if getgenv().InfJ then
            local humanoid = Players.LocalPlayer.Character:FindFirstChildOfClass'Humanoid'
            if humanoid then humanoid:ChangeState("Jumping") end
        end
    end)

    PlayerTab:Button("Rejoin", function()
        TeleportService:Teleport(game.PlaceId, Players.LocalPlayer)
    end)

    -- Visual Tab
    VisualTab:Toggle("Character Highlight", function(state)
        getgenv().enabled = state
        getgenv().filluseteamcolor = true
        getgenv().outlineuseteamcolor = true
        getgenv().fillcolor = Color3.new(0,0,0)
        getgenv().outlinecolor = Color3.new(1,1,1)
        getgenv().filltrans = 0.5
        getgenv().outlinetrans = 0.5
        loadstring(game:HttpGet("https://raw.githubusercontent.com/Vcsk/RobloxScripts/main/Highlight-ESP.lua"))()
    end)

    VisualTab:Toggle("(Everyone) ESP Name", function(state)
        getgenv().ESPName = state
    end)

    VisualTab:Toggle("(Enemy Only) ESP Name (soon!)", function(state)
        getgenv().TeamCheckkk = state
    end)

    -- ESP Logic
    local Camera = Workspace.CurrentCamera
    local LocalPlayer = Players.LocalPlayer

    local function esp(p, cr)
        local h = cr:WaitForChild("Humanoid")
        local hrp = cr:WaitForChild("Head")

        local text = Drawing.new("Text")
        text.Visible = false
        text.Center = true
        text.Outline = false
        text.Font = 3
        text.Size = 16
        text.Color = Color3.new(1,1,1)

        local function remove()
            text:Remove()
        end

        RunService.RenderStepped:Connect(function()
            if getgenv().ESPName then
                local pos, vis = Camera:WorldToViewportPoint(hrp.Position)
                if vis then
                    text.Position = Vector2.new(pos.X, pos.Y)
                    text.Text = p.Name
                    text.Visible = true
                else
                    text.Visible = false
                end
            else
                text.Visible = false
            end
        end)
    end

    for i,v in pairs(Players:GetPlayers()) do
        if v ~= LocalPlayer then
            if v.Character then
                esp(v,v.Character)
            end
        end
    end
    Players.PlayerAdded:Connect(function(v)
        v.CharacterAdded:Connect(function(c)
            esp(v,c)
        end)
    end)
end

-- ==============================
-- KEY SUBMIT BUTTON
-- ==============================
SubmitButton.MouseButton1Click:Connect(function()
    if isKeyValid(TextBox.Text) then
        runScript()
    else
        TextLabel.Text = "Invalid Key! Try again."
    end
end)
